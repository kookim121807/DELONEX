<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CHRONOS Orbit Simulator </title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64' fill='none' stroke='%230b1220' stroke-width='4.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='32' cy='32' r='18' fill='%23c7f9e9'/%3E%3Cpath d='M13 30.5c7-13 30-17 40-5'/%3E%3Cpath d='M17 37.5c7 10 24 14 32 5'/%3E%3Ccircle cx='32' cy='32' r='7' fill='%230b1220'/%3E%3Ccircle cx='46' cy='24' r='3' fill='%230b1220'/%3E%3C/svg%3E">
  <meta name="theme-color" content="#050816"/>

  <style>
    :root{
      --bg:#050816;
      --bg-soft:#090d1a;
      --panel:#101626;
      --edge:rgba(255,255,255,.1);
      --edge-soft:rgba(255,255,255,.06);
      --ink:#eaf1ff;
      --ink-soft:#a7b4d5;
      --accent:#4fd1c5;
      --accent-soft:#81e6d9;
      --danger:#f56565;
      --radius:18px;
      --shadow-soft:0 14px 40px rgba(0,0,0,.55);
      --code:#1a2238;
    }

    *{
      box-sizing:border-box;
      margin:0;
      padding:0;
    }
    body, body *{
      -webkit-user-select:none;
      user-select:none;
    }
    input, textarea, select, option{
      -webkit-user-select:text;
      user-select:text;
    }

    html,body{
      height:100%;
    }

    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:
        radial-gradient(1200px 900px at 8% -10%, rgba(79,209,197,.30), transparent 60%),
        radial-gradient(1200px 900px at 92% -20%, rgba(129,230,217,.25), transparent 60%),
        radial-gradient(1400px 900px at 50% 120%, rgba(124,112,255,.20), transparent 60%),
        linear-gradient(180deg,#050816,#020412);
      color:var(--ink);
      -webkit-font-smoothing:antialiased;
    }

    /* light mode */
    body.light-theme{
      --bg:#f4f5ff;
      --bg-soft:#e5e7ff;
      --panel:#ffffff;
      --edge:rgba(15,23,42,.13);
      --edge-soft:rgba(15,23,42,.08);
      --ink:#020617;
      --ink-soft:#4b5563;
      --code:#e2e8f0;
      background:
        radial-gradient(1100px 800px at 8% -10%, rgba(79,209,197,.15), transparent 60%),
        radial-gradient(1100px 800px at 92% -20%, rgba(129,230,217,.12), transparent 60%),
        linear-gradient(180deg,#f9fafb,#e5e7eb);
      color:var(--ink);
    }

    a{
      color:inherit;
      text-decoration:none;
    }

    button{
      font:inherit;
      color:inherit;
      background:transparent;
      border:0;
      cursor:pointer;
    }

    input,select{
      font:inherit;
      color:inherit;
      background:rgba(5,12,32,.7);
      border-radius:12px;
      border:1px solid var(--edge);
      padding:.45rem .65rem;
      min-width:0;
      outline:none;
    }

    body.light-theme input,
    body.light-theme select{
      background:#f8fafc;
    }

    input:focus,select:focus{
      border-color:var(--accent-soft);
      box-shadow:0 0 0 1px rgba(129,230,217,.7);
    }

    label{
      font-size:.86rem;
      color:var(--ink-soft);
    }

    header{
      position:relative;
      top:auto;
      z-index:10;
      border-bottom:1px solid var(--edge);
      background:linear-gradient(180deg,rgba(3,5,16,.96),rgba(3,5,16,.86));
      backdrop-filter:blur(12px) saturate(140%);
      padding:10px 0;
    }

    body.light-theme header{
      background:linear-gradient(180deg,#f9fafb,#e5e7eb);
      border-bottom:1px solid rgba(148,163,184,.7);
    }

    .header-inner{
      position:relative;
      max-width:100vw;
      width:100%;
      margin:0 auto;
      padding:12px clamp(10px,2vw,16px);
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
      justify-content:space-between;
    }
    .nav-brand{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      display:flex;
      align-items:center;
      gap:12px;
    }
    .nav-title{
      margin:0;
      font-size:1.2rem; 
      letter-spacing:.1em;
      text-transform:uppercase;
      font-weight:800;
      white-space:nowrap;
    }
    .nav-actions{
      display:flex;
      align-items:center;
      gap:.5rem;
      justify-content:flex-end;
      min-width:0;
      margin-left:auto;
      flex-wrap:wrap;
      position:relative;
    }
    #themeToggle,
    .top-menu .menu-item[data-action="theme"]{
      font-size:1.35rem;
      line-height:1;
      border-radius:14px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:48px;
      height:48px;
    }
    .nav-spacer{ display:none; }

    @media (max-width:1100px){
      .nav-brand{
        position:static;
        transform:none;
        margin-right:auto;
      }
      .nav-title{ font-size:1.05rem; }
      .nav-actions{ margin-left:0; }
    }

    @media (max-width:880px){
      .nav-brand{
        position:static;
        transform:none;
        margin-right:auto;
      }
      .header-inner{
        justify-content:space-between;
        flex-wrap:wrap;
      }
      .nav-actions{
        margin-left:0;
      }
    }

    .logo-orb{
      width:48px;
      height:48px;
      border-radius:50%;
      display:grid;
      place-items:center;
      background:
        radial-gradient(circle at 28% 24%, rgba(255,255,255,0.9), rgba(255,255,255,0.12) 32%, transparent 45%),
        conic-gradient(from 200deg,#6ee7b7,#7ac6ff,#c9a0ff,#f6c17c,#5ef3c2,#7ac6ff);
      color:#0c1220;
      font-weight:900;
      letter-spacing:.06em;
      box-shadow:0 6px 18px rgba(0,0,0,.32), 0 0 0 1px rgba(255,255,255,.04), var(--shadow-soft);
      position:relative;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.08);
      flex:none;
      transform:translateZ(0);
      color:#0c1220;
    }
    .logo-orb.logo-orb-mini{
      width:30px;
      height:30px;
      display:grid;
      place-items:center;
      font-size:.9rem;
      letter-spacing:.06em;
      border-radius:10px;
      background:
        radial-gradient(circle at 28% 24%, rgba(255,255,255,0.9), rgba(255,255,255,0.12) 32%, transparent 45%),
        conic-gradient(from 200deg,#6ee7b7,#7ac6ff,#c9a0ff,#f6c17c,#5ef3c2,#7ac6ff);
      color:#0c1220;
      font-weight:900;
      box-shadow:0 4px 12px rgba(0,0,0,.26), 0 0 0 1px rgba(255,255,255,.06);
      color:#eaf1ff;
    }
    body.light-theme .logo-orb.logo-orb-mini{
      color:#0c1220;
    }
    .logo-orb svg{ width:74%; height:74%; }
    .logo-orb-mini svg{ width:90%; height:90%; }
    .logo-glyph{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:26px;
      height:26px;
      color:var(--ink);
    }
    .logo-glyph svg{
      width:100%;
      height:100%;
    }
    body.light-theme .logo-glyph{
      color:#0c1220;
    }
    .top-menu .logo-glyph{
      width:28px;
      height:28px;
      color:#eaf1ff;
    }
    body.light-theme .top-menu .logo-glyph{
      color:#0c1220;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:8px;
      margin:0;
    }

    .layout{
      max-width:1400px;
      margin:14px auto 24px;
      padding:0 16px 18px;
      display:grid;
      grid-template-columns:320px minmax(0,1.4fr);
      gap:16px;
    }

    @media (max-width:1100px){
      .layout{
        grid-template-columns:1fr;
      }
    }

    .panel{
      background:var(--panel);
      border-radius:var(--radius);
      border:1px solid var(--edge-soft);
      box-shadow:var(--shadow-soft);
      overflow:hidden;
      position:relative;
    }

    .panel-header{
      padding:10px 14px;
      border-bottom:1px solid var(--edge-soft);
      display:flex;
      align-items:center;
      gap:10px;
      justify-content:space-between;
    }

    .panel-title{
      font-size:.98rem;
      display:flex;
      align-items:center;
      gap:.5rem;
      text-transform:uppercase;
      letter-spacing:.16em;
      color:var(--ink-soft);
    }

    /* controls panel */
    #controlPanel .panel-header{
      flex-direction:column;
      align-items:flex-start;
      gap:6px;
    }

    .panel-body{
      padding:12px 14px 14px;
    }

    .section-label{
      font-size:.78rem;
      text-transform:uppercase;
      letter-spacing:.16em;
      color:var(--ink-soft);
      opacity:.9;
      margin-bottom:12px;
    }

    .control-group{
      display:grid;
      grid-template-columns:1.1fr 1fr;
      gap:8px 10px;
      align-items:center;
      margin-bottom:10px;
    }

    .control-group-full{
      grid-template-columns:1fr;
    }

    .row{
      display:flex;
      align-items:center;
      gap:.5rem;
      flex-wrap:wrap;
    }

    .pill{
      border-radius:999px;
      padding:.2rem .65rem;
      font-size:.8rem;
      border:1px solid var(--edge-soft);
      color:var(--ink-soft);
      background:rgba(6,10,28,.9);
    }

    body.light-theme .pill{
      background:#edf2ff;
      border-color:rgba(148,163,184,.8);
    }

    .pill strong{
      color:var(--accent-soft);
      font-weight:600;
    }

    .field-inline{
      display:flex;
      align-items:center;
      gap:.35rem;
    }

    .field-inline label{
      font-size:.8rem;
      min-width:64px;
    }

    .slider-row{
      display:grid;
      grid-template-columns:minmax(0,1.1fr) 64px;
      gap:6px;
      align-items:center;
    }

    input[type="range"]{
      -webkit-appearance:none;
      appearance:none;
      height:6px;
      border-radius:999px;
      background:#1a2337;
      outline:none;
    }

    body.light-theme input[type="range"]{
      background:#cbd5f5;
    }

    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none;
      appearance:none;
      width:16px;
      height:16px;
      border-radius:50%;
      background:var(--accent-soft);
      box-shadow:0 0 0 3px rgba(129,230,217,.35);
      cursor:pointer;
      border:none;
    }

    input[type="range"]::-moz-range-thumb{
      width:16px;
      height:16px;
      border-radius:50%;
      background:var(--accent-soft);
      box-shadow:0 0 0 3px rgba(129,230,217,.35);
      cursor:pointer;
      border:none;
    }

    .preset-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:6px;
      margin-bottom:10px;
    }

    .preset-btn{
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.04);
      padding:.5rem .8rem;
      background:linear-gradient(180deg, rgba(7,12,28,.85), rgba(8,14,32,.95));
      min-height:64px;
      box-shadow:inset 0 1px 0 rgba(255,255,255,0.02);
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .preset-btn:hover{ transform:translateY(-4px); box-shadow:0 10px 30px rgba(4,120,111,.06); }

    .preset-btn-active{
      border:1px solid rgba(129,230,217,0.9);
      background:linear-gradient(180deg, rgba(18,36,48,0.98), rgba(5,10,25,0.95));
      box-shadow:0 6px 32px rgba(79,209,197,0.12);
    }

    body.light-theme .preset-btn strong,
    body.light-theme .preset-btn span {
      color: var(--ink);
    }

    body.light-theme .preset-btn {
      color: var(--ink);
      background: linear-gradient(180deg,#ffffff,#f3f6ff);
      border: 1px solid rgba(15,23,42,0.06);
      box-shadow: 0 6px 18px rgba(2,6,23,0.06);
    }
    body.light-theme .preset-btn:hover{
      transform: translateY(-3px);
      box-shadow: 0 10px 28px rgba(2,6,23,0.08);
    }
    body.light-theme .preset-btn.preset-btn-active {
      border-color: rgba(79,209,197,0.9);
      background: linear-gradient(180deg,#eefaf6,#e6fbf8);
    }

    .status-card{
      border-radius:12px;
      border:1px solid var(--edge-soft);
      background:linear-gradient(145deg,rgba(10,16,40,.96),rgba(6,10,26,.96));
      padding:8px 9px;
      margin-top:4px;
      font-size:.82rem;
    }

    body.light-theme .status-card{
      background:#f8fafc;
    }

    .status-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:4px 10px;
      margin-top:4px;
    }

    .status-label{
      color:var(--ink-soft);
      opacity:.9;
    }

    .status-value{
      text-align:right;
      font-feature-settings:"tnum" 1,"lnum" 1;
    }

    .status-value.positive{
      color:#9ae6b4;
    }

    .status-value.negative{
      color:#feb2b2;
    }

    .hint{
      font-size:.78rem;
      color:var(--ink-soft);
      margin-top:6px;
      line-height:1.4;
    }

    .hint code{
      background:rgba(15,23,42,.9);
      border-radius:8px;
      padding:.08rem .35rem;
      font-size:.78rem;
      font-family:ui-monospace,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    }

    body.light-theme .hint code{
      background:#e5e7eb;
    }

    .canvas-wrap{
      position:relative;
      padding:10px 10px 12px;
    }

    .canvas-shell{
      position:relative;
      border-radius:var(--radius);
      border:1px solid var(--edge-soft);
      background:
        radial-gradient(circle at 10% 0%,rgba(79,209,197,.16),transparent 55%),
        radial-gradient(circle at 90% 0%,rgba(129,230,217,.18),transparent 55%),
        radial-gradient(circle at 50% 110%,rgba(124,112,255,.20),transparent 60%),
        #020617;
      overflow:hidden;
    }

    canvas{
      display:block;
      width:100%;
      height:520px;
    }

    @media (max-width:700px){
      canvas{
        height:440px;
      }
    }

    .canvas-overlay{
      position:absolute;
      inset:0;
      pointer-events:none;
    }

    .hud-row{
      position:absolute;
      right:10px;
      bottom:10px;
      display:flex;
      align-items:center;
      gap:6px;
      pointer-events:none;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .hud-pill{
      pointer-events:auto;
      font-size:.8rem;
      border-radius:999px;
      padding:.25rem .6rem;
      border:1px solid rgba(148,163,184,.8);
      background:rgba(15,23,42,.86);
      color:var(--ink-soft);
      display:inline-flex;
      align-items:center;
      gap:.35rem;
    }

    body.light-theme .hud-pill{
      background:#e5e7f1;
      border-color:rgba(148,163,184,.9);
    }

    .hud-dot{
      width:6px;
      height:6px;
      border-radius:999px;
      background:#4ade80;
      box-shadow:0 0 0 2px rgba(34,197,94,.45);
    }

    .hud-pill strong{
      color:var(--accent-soft);
      font-weight:600;
      font-feature-settings:"tnum" 1,"lnum" 1;
    }

    .hud-bottom{
      position:absolute;
      left:10px;
      bottom:10px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .legend{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
    }

    .legend-item{
      border-radius:999px;
      border:1px solid rgba(148,163,184,.8);
      background:rgba(15,23,42,.86);
      padding:.16rem .5rem;
      font-size:.76rem;
      display:flex;
      align-items:center;
      gap:.3rem;
    }

    body.light-theme .legend-item{
      background:#e5e7f1;
    }

    .legend-color{
      width:10px;
      height:10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.9);
    }

    @media (max-width:820px){
      .canvas-overlay{
        display:flex;
        flex-direction:column;
        justify-content:flex-end;
        align-items:flex-start;
        gap:6px;
        padding:10px;
      }
      .hud-row{
        position:static;
        right:auto;
        bottom:auto;
        width:100%;
        justify-content:flex-start;
        flex-wrap:wrap;
        gap:6px;
      }
      .hud-bottom{
        position:static;
        left:auto;
        bottom:auto;
        display:flex;
        flex-direction:column;
        gap:6px;
        width:100%;
      }
      .legend{
        gap:6px;
      }
    }

    .footer-note{
      margin-top:8px;
      font-size:.78rem;
      color:var(--ink-soft);
      opacity:.85;
    }

    .footer-note strong{
      color:var(--accent-soft);
    }

    /* buttons */
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:.5rem;
      padding:.72rem 1rem;
      border:1px solid var(--edge);
      border-radius:12px;
      background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03));
      font-size:.9rem;
      font-weight:800;
      white-space:nowrap;
      color:var(--ink);
    }

    .btn-ghost{
      background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03));
    }

    .btn-primary{
      background:linear-gradient(180deg,var(--accent),#3ae0d0);
      color:#ffffff;
      border:0;
      box-shadow:0 8px 28px rgba(58,224,208,.32);
    }

    body.light-theme .btn-primary{
      color:#0b1220;
    }

    .btn-danger{
      border-color:rgba(245,101,101,.8);
      color:#fed7d7;
      background:linear-gradient(180deg,rgba(245,101,101,.26),rgba(245,101,101,.08));
    }

    .btn-sm{
      padding:.55rem .78rem;
      font-size:.85rem;
      border-radius:12px;
    }

    body.light-theme .btn:not(.btn-primary):not(.btn-danger){
      background:linear-gradient(180deg,rgba(255,255,255,.95),rgba(226,232,240,.95));
      border-color:rgba(148,163,184,.45);
      color:#0b1120;
      box-shadow:0 6px 16px rgba(15,23,42,.12);
    }

    /* header control*/
    .controls-header-row{
      flex-wrap:wrap;
      gap:.35rem;
    }

    .controls-header-row .btn-sm{
      padding:.32rem .6rem;
      font-size:.76rem;
    }

    .control-with-toggle{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      width:100%;
    }

    .control-with-toggle .slider-row{
      flex:1 1 auto;
      display:grid;
      grid-template-columns:1fr 72px;
      gap:8px;
      align-items:center;
    }

    .ctrl-toggle{
      width:52px;
      height:28px;
      border-radius:999px;
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border:1px solid rgba(255,255,255,0.04);
      display:flex;
      align-items:center;
      padding:3px;
      cursor:pointer;
      flex:none;
      box-shadow:inset 0 1px 0 rgba(255,255,255,0.02), 0 6px 18px rgba(2,6,23,0.5);
      transition:all .18s ease;
    }

    /* toggle knob */
    .ctrl-toggle .knob{
      width:22px;
      height:22px;
      border-radius:50%;
      background:linear-gradient(180deg,#d6dbe6,#9aa4bf); 
      box-shadow:0 2px 6px rgba(2,6,23,0.6);
      transform:translateX(0); 
      transition:transform .18s ease, box-shadow .18s ease, background .18s ease;
      margin-left:2px;
    }

    .ctrl-toggle{
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    }

    .ctrl-toggle:not(.ctrl-toggle--off) .knob{
      background:linear-gradient(180deg,#dffbf6,#9ef0df);
      box-shadow:0 8px 18px rgba(79,209,197,0.12), 0 1px 0 rgba(255,255,255,0.2) inset;
      transform:translateX(22px);
    }

    .ctrl-toggle.ctrl-toggle--off{
      background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.01));
      border:1px solid rgba(255,255,255,0.03);
    }

    .control-active{
      box-shadow:0 6px 18px rgba(79,209,197,0.06);
      border-radius:12px;
    }

    /* visuals*/
    .visuals-row{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:8px;
    }

    /* visuals buttons */
    .visuals-btn {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      white-space:nowrap;
      gap:.65rem;
      padding:.62rem .95rem;
      min-width:0;
      flex:1 1 0; 
      min-height:78px; 
      border-radius:13px;
      border:1px solid rgba(129,230,217,0.24);
      background:linear-gradient(145deg, rgba(19,30,52,0.92), rgba(12,20,38,0.92));
      font-weight:800;
      font-size:.94rem;
      letter-spacing:.01em;
      transition:transform .14s ease, box-shadow .14s ease, border-color .14s ease;
      cursor:pointer;
      position:relative;
      overflow:hidden;
      box-shadow:inset 0 1px 0 rgba(255,255,255,0.04), 0 12px 30px rgba(2,6,23,0.45);
    }
    .visuals-btn::after{
      content:"";
      position:absolute;
      inset:-1px;
      border-radius:inherit;
      background:radial-gradient(circle at 15% 10%, rgba(129,230,217,0.18), transparent 35%), radial-gradient(circle at 80% 20%, rgba(96,165,250,0.12), transparent 40%);
      opacity:0;
      transition:opacity .18s ease;
      pointer-events:none;
    }
    .visuals-btn:hover{
      transform:translateY(-2px);
      border-color:rgba(129,230,217,0.42);
      box-shadow:inset 0 1px 0 rgba(255,255,255,0.06), 0 16px 38px rgba(4,120,111,0.30);
    }
    .visuals-btn:hover::after{ opacity:1; }
    .visuals-btn svg{
      width:24px;
      height:24px;
      flex:none;
      padding:8px;
      border-radius:11px;
      background:linear-gradient(135deg,#b2f5ea,#4fd1c5);
      color:#041022;
      box-shadow:0 8px 18px rgba(79,209,197,0.24);
    }
    .visuals-btn svg path{ stroke:currentColor; stroke-width:2.4; }

    /* light theme */
    body.light-theme .visuals-btn{
      background:linear-gradient(145deg,#e8f5fb,#dbe8f4);
      color:#0f172a;
      border-color:rgba(79,209,197,0.4);
      box-shadow:inset 0 1px 0 rgba(255,255,255,0.8), 0 12px 24px rgba(148,163,184,0.35);
    }
    body.light-theme .visuals-btn::after{
      background:radial-gradient(circle at 18% 16%, rgba(79,209,197,0.24), transparent 40%), radial-gradient(circle at 82% 18%, rgba(96,165,250,0.2), transparent 42%);
    }
    body.light-theme .visuals-btn svg{
      background:linear-gradient(135deg,#9ef0df,#4fd1c5);
      color:#0f172a;
      box-shadow:0 8px 16px rgba(79,209,197,0.25);
    }
    body.light-theme .visuals-btn svg path{ stroke-width:2.6; }

   /* advanced visuals panel */
   .visuals-panel {
     display:flex;
     flex-direction:column;
     gap:10px;
     padding:10px;
     border-radius:12px;
     background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));
     border:1px solid var(--edge-soft);
     box-shadow:0 6px 18px rgba(2,6,23,0.45) inset;
   }

   .btn-trail {
     display:inline-flex;
     align-items:center;
     gap:.6rem;
     padding:.55rem .8rem;
     border-radius:12px;
     background:linear-gradient(135deg, rgba(79,209,197,0.08), rgba(96,165,250,0.06));
     border:1px solid rgba(79,209,197,0.12);
     box-shadow:0 8px 20px rgba(2,6,23,0.45);
     min-width:170px;
   }

   .trail-slider { display:flex; gap:10px; align-items:center; flex:1; min-width:220px; }
   .trail-slider input[type="range"]{
     width:100%;
     height:8px;
     background:linear-gradient(90deg, rgba(10,16,28,0.95), rgba(18,30,48,0.95));
     border-radius:999px;
     -webkit-appearance:none;
     appearance:none;
   }
   .trail-slider input[type="range"]::-webkit-slider-thumb{
     -webkit-appearance:none;
     appearance:none;
     width:18px;
     height:18px;
     border-radius:50%;
     background:linear-gradient(180deg,#9ef0df,#4fd1c5);
     box-shadow:0 8px 20px rgba(79,209,197,0.12);
     border:none;
     margin-top:-5px;
   }

   .trail-length-badge{
     background:linear-gradient(90deg,var(--accent),var(--accent-soft));
     color:#041022;
     padding:.36rem .7rem;
     border-radius:999px;
     font-weight:800;
     font-size:.86rem;
     box-shadow:0 10px 24px rgba(79,209,197,0.06);
     min-width:64px;
     text-align:center;
   }

   .visuals-row .visuals-btn{
     padding:.6rem .85rem;
     border-radius:12px;
     box-shadow:0 8px 20px rgba(2,6,23,0.45);
   }

    .trail-controls {
      display:flex;
      gap:8px;
      align-items:center;
      min-width:220px;
    }

    .trail-slider {
      display:flex;
      gap:8px;
      align-items:center;
      width:100%;
    }

    .trail-length-badge{
      background:linear-gradient(90deg,var(--accent),var(--accent-soft));
      color:#041022;
      padding:.25rem .45rem;
      border-radius:999px;
      font-weight:700;
      font-size:.82rem;
      box-shadow:0 6px 18px rgba(79,209,197,0.06);
      min-width:64px;
      text-align:center;
    }

    /* stat cards */
    .stat-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:8px;
      margin-top:8px;
    }

    .stat-card{
      padding:10px;
      border-radius:12px;
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border:1px solid var(--edge-soft);
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .stat-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }

    @media (max-width:520px){
      .stat-row{
        flex-direction:column;
        align-items:flex-start;
        gap:6px;
      }
      .stat-value{
        text-align:left;
      }
      .stat-bar-wrap{
        width:100%;
      }
    }

    .stat-label{ color:var(--ink-soft); font-size:.8rem; }

    .stat-value{ font-weight:700; font-feature-settings:"tnum" 1,"lnum" 1; }

    .stat-bar-wrap{
      height:8px;
      background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:999px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,0.03);
    }

    .stat-bar{
      height:100%;
      width:0%;
      transition:width .28s ease;
      border-radius:999px;
    }

    .stat-bar-ek{ background:linear-gradient(90deg,#9ae6b4,#4fd1c5); }
    .stat-bar-ep{ background:linear-gradient(90deg,#fecaca,#f56565); }
    .stat-bar-v{ background:linear-gradient(90deg,#a5b4fc,#60a5fa); }
    .stat-bar-r{ background:linear-gradient(90deg,#fbd38d,#f6ad55); }
    .stat-bar-etot{ background:linear-gradient(90deg,#c4b5fd,#7c3aed); }

    @media (max-width:700px){
      .stat-grid{ grid-template-columns:1fr; }
    }

    /* navigation menu */
    .menu-toggle{
      display:none;
      align-items:center;
      justify-content:center;
      width:44px;
      height:44px;
      border-radius:12px;
      border:1px solid var(--edge);
      background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.04));
      box-shadow:0 6px 16px rgba(0,0,0,.25);
      color:var(--ink);
    }
    .nav-actions.nav-collapsed > .nav-btn { display:none; }
    .nav-actions.nav-collapsed #themeToggle { display:none !important; }
    .nav-actions.nav-collapsed > .menu-toggle { display:inline-flex; }
    .nav-actions.nav-collapsed > .logo-btn{ display:none !important; }
    .menu-toggle svg{ width:18px; height:18px; opacity:.9; }

    /* header buttons */
    .nav-actions .nav-btn{
      padding:.6rem 1.1rem;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background:linear-gradient(145deg,rgba(255,255,255,.05),rgba(255,255,255,.02));
      box-shadow:0 6px 18px rgba(0,0,0,.28);
      font-weight:800; 
      font-size:.95rem;
      color:var(--ink);
      min-height:42px;
    }
    .nav-actions .btn-primary{
      background:linear-gradient(135deg,#36e0ce,#21c3b4);
      border:0;
      color:#ffffff;
      box-shadow:0 10px 26px rgba(54,224,206,.4);
    }
    body.light-theme .nav-actions .btn-primary{
      color:#041017;
    }
    .nav-actions .nav-btn:not(.btn-primary):hover{
      border-color:rgba(255,255,255,.16);
      box-shadow:0 8px 22px rgba(0,0,0,.32);
    }
    .nav-actions .nav-btn.logo-btn{
      padding:.35rem;
      width:44px;
      min-width:44px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .nav-actions .nav-btn.logo-btn .logo-orb-mini{
      width:26px;
      height:26px;
    }

    .top-menu{
      position:absolute;
      right:0;
      top:calc(100% + 10px);
      background:linear-gradient(180deg,rgba(10,16,32,.94),rgba(5,10,24,.9));
      border:1px solid var(--edge);
      border-radius:14px;
      padding:6px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
      min-width:0;
      box-shadow:0 16px 40px rgba(0,0,0,.32);
      z-index:1500;
    }
    .top-menu .menu-item{
      display:flex;
      width:52px;
      height:52px;
      min-height:52px;
      justify-content:center;
      align-items:center;
      padding:.35rem;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.08);
      font-weight:700;
      font-size:.8rem;
      line-height:1.2;
      text-align:center;
      white-space:normal;
      box-shadow:0 5px 12px rgba(0,0,0,.16);
      background:linear-gradient(145deg,rgba(255,255,255,.05),rgba(255,255,255,.015));
    }
    .top-menu .menu-item.btn-primary{
      background:linear-gradient(135deg,#33e6d4,#1dc3b1);
      color:#03121a;
      border:0;
      box-shadow:0 8px 18px rgba(51,214,198,.32);
    }
    .top-menu .menu-item.logo-btn{
      padding:0;
      background:linear-gradient(145deg,rgba(255,255,255,.05),rgba(255,255,255,.015));
      border:1px solid rgba(255,255,255,.08);
    }
    .top-menu .menu-item[data-action="theme"]{
      width:48px;
      height:48px;
      font-size:1.4rem;
    }
    .top-menu .menu-item.logo-btn .logo-orb-mini{
      width:28px;
      height:28px;
    }
    .top-menu .menu-item svg{ width:20px; height:20px; }
    body.light-theme .top-menu{
      background:linear-gradient(180deg,rgba(249,250,251,.98),rgba(226,232,240,.95));
      border-color:rgba(148,163,184,.45);
      box-shadow:0 12px 30px rgba(15,23,42,.12);
    }

    @media (max-width: 720px){
      .menu-toggle{ display:inline-flex; }
      .nav-actions > .nav-btn{ display:none; }
      .nav-actions{ gap:6px; }
      #themeToggle,
      .top-menu .menu-item[data-action="theme"]{
        font-size:1.35rem;
        width:52px;
        height:52px;
      }
    }

    body.light-theme input::placeholder,
    body.light-theme textarea::placeholder,
    body.light-theme select::placeholder,
    body.light-theme ::placeholder {
      color: #94a3b8;
      opacity: 1;
    }

    .site-footer{
      text-align: center;
      padding: 12px 0;
      color: var(--ink-soft);
      font-size: 0.95rem;
      width: 100%;
    }

    @media (max-width:960px){
      .canvas-shell{
        padding-bottom:140px;
        overflow:visible;
      }
    }

    @media (max-width:820px){
      .canvas-overlay{
        padding:10px 10px 90px;
        bottom:-110px;
      }
      .hud-row .hud-pill{
        font-size:.78rem;
        padding:.2rem .45rem;
      }
      .hud-bottom .legend{
        flex-direction:column;
        gap:6px;
      }
      .legend-item{
        width:100%;
      }
    }

    @media (max-width:780px){
      .visuals-panel{
        padding:8px;
        gap:6px;
      }
      .visuals-btn{
        font-size:.88rem;
        min-height:60px;
        padding:.5rem .8rem;
      }
      .visuals-btn svg{
        padding:6px;
        width:20px;
        height:20px;
      }
    }

    @media (max-width:840px){
      .visuals-row{
        grid-template-columns:repeat(2,minmax(0,1fr));
      }
    }

    .visuals-row .visuals-btn{
      padding:.6rem .85rem;
      border-radius:12px;
      box-shadow:0 8px 20px rgba(2,6,23,0.45);
    }

    @media (max-width:640px){
      .visuals-row{
        grid-template-columns:repeat(1,minmax(0,1fr));
      }
      .trail-controls{
        flex-direction:column;
        align-items:stretch;
      }
      .trail-slider{
        width:100%;
      }
      .trail-length-badge{
        font-size:.74rem;
      }
    }
  </style>
</head>
<body>

<header>
  <div class="header-inner">
    <div class="nav-brand">
      <div class="logo-orb" role="img" aria-label="Chronos emblem">
        <svg viewBox="0 0 64 64" aria-hidden="true" focusable="false">
          <g fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" stroke-opacity=".72">
            <circle cx="32" cy="32" r="14"/>
            <path d="M13.5 30.5c6-12.5 27-17.5 37-6.8"/>
            <path d="M17 36.8c6.2 11 23.4 14.6 32.6 5.8"/>
            <path d="M30 17.5c0 2.5 2.2 4.5 5 4.5"/>
            <path d="M23 32h-4"/>
            <path d="M45 32h-3.5"/>
          </g>
          <g fill="currentColor" fill-opacity=".95">
            <circle cx="32" cy="32" r="6"/>
            <circle cx="46" cy="24" r="3"/>
          </g>
        </svg>
      </div>
      <div class="nav-title">CHRONOS</div>
    </div>
    <div class="nav-spacer"></div>
    <div class="nav-actions" id="navActions">
      <button id="btnReset" class="btn btn-ghost nav-btn" title="Reset pan / zoom (R)">Reset View</button>
      <button id="btnExport" class="btn btn-primary nav-btn" title="Export simulation video (E)">Export Video</button>
      <button id="themeToggle" class="btn btn-ghost nav-btn" title="Toggle theme (click)" aria-label="Toggle theme"></button>
      <button id="btnHelp" class="btn btn-ghost nav-btn" title="Help (?)">Help</button>
      <button id="btnBrand" class="btn btn-ghost nav-btn logo-btn" title="Chronos" aria-label="Chronos logo button">
        <span class="logo-glyph" aria-hidden="true">
          <svg viewBox="0 0 64 64" focusable="false">
            <g fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" stroke-opacity="1">
              <circle cx="32" cy="32" r="14"/>
              <path d="M13.5 30.5c6-12.5 27-17.5 37-6.8"/>
              <path d="M17 36.8c6.2 11 23.4 14.6 32.6 5.8"/>
            </g>
            <g fill="currentColor" fill-opacity="1">
              <circle cx="32" cy="32" r="6"/>
              <circle cx="46" cy="24" r="3"/>
            </g>
          </svg>
        </span>
      </button>
      <button id="menuToggle" class="menu-toggle" aria-label="Open menu" title="Open menu" style="display:none">
        <svg viewBox="0 0 24 24" aria-hidden="true"><g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M4 8h16M7 12h13M10 16h10"/></g></svg>
      </button>
      <div id="topMenu" class="top-menu" aria-hidden="true" style="display:none">
        <button class="menu-item btn btn-ghost" data-action="reset">Reset View</button>
        <button class="menu-item btn btn-primary" data-action="export">Export Video</button>
        <button class="menu-item btn btn-ghost" data-action="theme" aria-label="Toggle theme"></button>
        <button class="menu-item btn btn-ghost" data-action="help">Help</button>
        <button class="menu-item btn btn-ghost logo-btn" data-action="brand" aria-label="Chronos logo">
          <span class="logo-glyph" aria-hidden="true">
            <svg viewBox="0 0 64 64" focusable="false">
            <g fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" stroke-opacity="1">
              <circle cx="32" cy="32" r="14"/>
              <path d="M13.5 30.5c6-12.5 27-17.5 37-6.8"/>
              <path d="M17 36.8c6.2 11 23.4 14.6 32.6 5.8"/>
            </g>
            <g fill="currentColor" fill-opacity="1">
              <circle cx="32" cy="32" r="6"/>
              <circle cx="46" cy="24" r="3"/>
            </g>
          </svg>
        </span>
        </button>
      </div>
    </div>
  </div>
</header>

<main class="layout">

  <!-- LEFT PANEL: CONTROLS -->
  <section class="panel" id="controlPanel">
    <div class="panel-header">
      <div class="panel-title">
        <span>Controls</span>
      </div>
      <div class="row controls-header-row">
        <button id="btnPlayPause" class="btn btn-primary btn-sm">
          ▶ Play
        </button>
        <button id="btnStep" class="btn btn-ghost btn-sm">
          Steps
        </button>
        <button id="btnClearTrail" class="btn btn-ghost btn-sm">
          Clear Trail
        </button>
      </div>
    </div>

    <div class="panel-body">

      <!-- PRESETS -->
      <div>
        <div class="section-label">Orbit Presets</div>
        <div class="preset-grid">
          <button class="preset-btn" data-preset="circular">
            <strong>Circular Mode</strong>
            <span>v ≈ √(GM/r)</span>
          </button>
          <button class="preset-btn" data-preset="elliptic">
            <strong>Elliptic Mode</strong>
            <span>Slower / Offset</span>
          </button>
          <button class="preset-btn" data-preset="escape">
            <strong>Escape Mode</strong>
            <span>v &gt; v<sub>esc</sub></span>
          </button>
          <button class="preset-btn" data-preset="crash">
            <strong>Crash Mode</strong>
            <span>Low v</span>
          </button>
        </div>
      </div>

      <!-- CENTRAL MASS -->
      <div style="margin-top:6px;">
        <div class="section-label">Central body (star)</div>

        <div class="control-group control-group-full">
          <label for="inputGM">GM (Strength)</label>
          <div class="slider-row">
            <input id="inputGMRange" type="range" min="5000" max="40000" step="500" value="15000"/>
            <input id="inputGM" type="number" value="15000" step="500"/>
          </div>
        </div>
      </div>

      <!-- PLANET INITIAL STATE -->
      <div style="margin-top:10px;">
        <div class="section-label">Planet Initial State</div>

        <div class="control-group control-group-full">
          <label for="inputRadius">Initial Radius ( r in px)</label>
          <div class="control-with-toggle">
            <div class="slider-row">
              <input id="inputRadiusRange" type="range" min="80" max="260" step="5" value="180"/>
              <input id="inputRadius" type="number" value="180" step="5"/>
            </div>
            <div class="ctrl-toggle ctrl-toggle--on" data-target="inputRadiusRange" title="Enable/disable radius">
              <div class="knob"></div>
            </div>
          </div>
        </div>

        <div class="control-group control-group-full">
          <label for="inputSpeedFactor">Speed Factor</label>
          <div class="control-with-toggle">
            <div class="slider-row">
              <input id="inputSpeedFactorRange" type="range" min="0.2" max="2.2" step="0.05" value="1.0"/>
              <input id="inputSpeedFactor" type="number" value="1.0" step="0.05"/>
            </div>
            <div class="ctrl-toggle ctrl-toggle--on" data-target="inputSpeedFactorRange" title="Enable/disable speed">
              <div class="knob"></div>
            </div>
          </div>
        </div>

        <div class="control-group control-group-full">
          <label for="inputAngle">Velocity Angle (deg)</label>
          <div class="control-with-toggle">
            <div class="slider-row">
              <input id="inputAngleRange" type="range" min="-180" max="180" step="5" value="90"/>
              <input id="inputAngle" type="number" value="90" step="5"/>
            </div>
            <div class="ctrl-toggle ctrl-toggle--on" data-target="inputAngleRange" title="Enable/disable angle">
              <div class="knob"></div>
            </div>
          </div>
        </div>

        <div class="control-group control-group-full">
          <label for="inputPhase">Start Phase (deg)</label>
          <div class="control-with-toggle">
            <div class="slider-row">
              <input id="inputPhaseRange" type="range" min="0" max="360" step="5" value="0"/>
              <input id="inputPhase" type="number" value="0" step="5"/>
            </div>
            <div class="ctrl-toggle ctrl-toggle--on" data-target="inputPhaseRange" title="Enable/disable phase">
              <div class="knob"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- INTEGRATION -->
      <div style="margin-top:12px;">
        <div class="section-label">Integration</div>

        <div class="control-group control-group-full">
          <label for="inputDt">Time Step Δt</label>
          <div class="control-with-toggle">
            <div class="slider-row">
              <input id="inputDtRange" type="range" min="0.002" max="0.06" step="0.002" value="0.016"/>
              <input id="inputDt" type="number" value="0.016" step="0.002"/>
            </div>
            <div class="ctrl-toggle ctrl-toggle--on" data-target="inputDtRange" title="Enable/disable dt">
              <div class="knob"></div>
            </div>
          </div>
        </div>

        <div class="control-group control-group-full">
          <label>Steps / Frame</label>
          <div class="field-inline">
            <select id="selectSubSteps">
              <option value="1">1 (fast & rough)</option>
              <option value="2" selected>2 (default)</option>
              <option value="4">4 (smoother)</option>
              <option value="8">8 (slower & stable)</option>
            </select>
          </div>
        </div>
      </div>

    </div>
  </section>

  <!-- RIGHT PANEL: CANVAS -->
  <section class="panel" id="canvasPanel">
    <div class="panel-header">
      <div class="panel-title">
        <span>Orbit view</span>
      </div>
      <div class="row">
        <span class="pill">
          <strong>Drag</strong> = Pan • <strong>Scroll</strong> = Zoom
        </span>
      </div>
    </div>

    <div class="canvas-wrap">
      <div class="canvas-shell">
        <canvas id="orbitCanvas"></canvas>
        <div class="canvas-overlay">

          <div class="hud-row">
            <div class="hud-pill">
              <div class="hud-dot" id="hudDot"></div>
              <span id="hudStateText">Paused</span>
            </div>
            <div class="hud-pill">
              dt eff:
              <strong id="hudDt">0.000</strong>
            </div>
            <div class="hud-pill">
              GM:
              <strong id="hudGM">15000</strong>
            </div>
          </div>

          <div class="hud-bottom">
            <div class="legend">
              <div class="legend-item">
                <div class="legend-color" style="background:#facc15;"></div>
                <span>Star (fixed)</span>
              </div>
              <div class="legend-item">
                <div class="legend-color" style="background:#60a5fa;"></div>
                <span>Planet Position</span>
              </div>
              <div class="legend-item">
                <div class="legend-color" style="background:#4fd1c5;"></div>
                <span>Trail (Orbit Path)</span>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <div class="panel-body">
      <div style="margin-top:12px;">
        <div class="section-label">Visuals</div>

        <div class="control-group control-group-full">
          <label>Trail</label>
          <div class="visuals-panel">
            <div class="trail-controls">
              <button id="btnTrailToggle" class="visuals-btn btn-trail" title="Toggle trail">
                <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle cx="6" cy="12" r="2" fill="#60a5fa"/><circle cx="12" cy="8" r="2" fill="#4fd1c5"/><circle cx="18" cy="14" r="2" fill="#facc15"/></svg>
                <div style="display:flex;flex-direction:column;align-items:flex-start;line-height:1">
                  <strong id="btnTrailToggleText">Trail: ON</strong>
                </div>
              </button>

              <div class="trail-slider">
                <input id="trailLengthRange" type="range" min="200" max="6000" step="100" value="1500" />
                <div class="trail-length-badge" id="trailLengthBadge">1500</div>
              </div>
            </div>

            <div class="visuals-row" style="margin-top:8px;">
              <button id="btnZoomIn" class="visuals-btn" title="Zoom in">
                <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M11 7v8M7 11h8" stroke="#041022" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                Zoom in
              </button>
              <button id="btnZoomOut" class="visuals-btn" title="Zoom out">
                <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M7 11h8" stroke="#041022" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                Zoom out
              </button>
              <button id="btnRecenter" class="visuals-btn" title="Re-center view">
                <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 5v2M12 17v2M5 12h2M17 12h2" stroke="#041022" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                Re-center
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- SIMULATION STATUS -->
      <div style="margin-top:12px;">
        <div class="section-label">Simulation status</div>
        <div class="status-card">
          <div class="row" style="justify-content:space-between;">
            <div class="pill">
              t = <strong id="statusTime">0.000</strong>
            </div>
            <div class="pill">
              Steps: <strong id="statusSteps">0</strong>
            </div>
          </div>

          <!-- REPLACED -->
          <div class="stat-grid">
            <div class="stat-card">
              <div class="stat-row">
                <div>
                  <div class="stat-label">r (distance)</div>
                </div>
                <div class="stat-value" id="statusR">0.000</div>
              </div>
              <div class="stat-bar-wrap"><div id="barR" class="stat-bar stat-bar-r"></div></div>
            </div>

            <div class="stat-card">
              <div class="stat-row">
                <div><div class="stat-label">|v| (speed)</div></div>
                <div class="stat-value" id="statusV">0.000</div>
              </div>
              <div class="stat-bar-wrap"><div id="barV" class="stat-bar stat-bar-v"></div></div>
            </div>

            <div class="stat-card">
              <div class="stat-row">
                <div><div class="stat-label">Kinetic E</div></div>
                <div class="stat-value positive" id="statusEk">0.000</div>
              </div>
              <div class="stat-bar-wrap"><div id="barEk" class="stat-bar stat-bar-ek"></div></div>
            </div>

            <div class="stat-card">
              <div class="stat-row">
                <div><div class="stat-label">Potential E</div></div>
                <div class="stat-value negative" id="statusEp">0.000</div>
              </div>
              <div class="stat-bar-wrap"><div id="barEp" class="stat-bar stat-bar-ep"></div></div>
            </div>

            <div class="stat-card">
              <div class="stat-row">
                <div><div class="stat-label">Total E</div></div>
                <div class="stat-value" id="statusEtot">0.000</div>
              </div>
              <div class="stat-bar-wrap"><div id="barEtot" class="stat-bar stat-bar-etot"></div></div>
            </div>

            <div class="stat-card">
              <div class="stat-row">
                <div><div class="stat-label">E Sign</div></div>
                <div class="stat-value" id="statusClass">–</div>
              </div>
              <div class="stat-bar-wrap"><div id="barClass" class="stat-bar stat-bar-etot" style="width:0%"></div></div>
            </div>
          </div>

          <p class="footer-note" style="margin-top:10px;">
            This is a simulator of <strong>two-body</strong> model where one massive body fixed at the origin, one light planet.  
            Real space missions we will add more bodies, perturbations, and better integrators to produce better outcome but the core idea is exactly this system.
          </p>
        </div>
      </div>
    </div>

  </section>

</main>

<!-- Help Tab -->
<div id="help">
  <div class="box">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3>Help • CHRONOS Orbit Simulator</h3>
      <button id="helpClose" class="btn" aria-label="Close help">X</button>
    </div>
    <div class="grid" style="grid-template-columns:1fr 1fr;gap:12px">
      <div class="card">
        <h4>Simulation Tips</h4>
        <ul>
          <li><strong>Presets:</strong> Change to 4 differet modes to set starting orbits.</li>
          <li><strong>Central Body:</strong> Raise or Lower <strong>GM</strong> for the planet.</li>
          <li><strong>Initial State:</strong> Tune radius, speed factor, velocity angle, and start phase for custom trajectories.</li>
          <li><strong>Visuals:</strong> Toggle the <strong>Trail</strong> and use the slider to set its length. <strong>Clear Trail</strong> wipes the path.</li>
        </ul>
      </div>
      <div class="card">
        <h4>Shortcuts</h4>
        <ul>
          <li><strong>Pan:</strong> <strong>Drag</strong> • <strong>Zoom:</strong> Wheel or +/-</li>
          <li><strong>Play / Pause:</strong> Space</li>
          <li><strong>Reset View:</strong> R (re-center pan/zoom)</li>
          <li><strong>Export Video:</strong> E (start / stop recording)</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<style>
#help{
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  background:rgba(6,10,20,.7);
  z-index:50;
  font-family:ui-sans-serif,system-ui,Inter,Segoe UI,Roboto,Arial;
}
#help .box{
  max-width:980px;
  width:min(92vw,980px);
  max-height:82vh;
  overflow:auto;
  background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.04));
  border:1px solid var(--edge);
  border-radius:16px;
  padding:18px;
}
#help .row{
  display:flex;
  align-items:center;
  gap:.6rem;
  flex-wrap:wrap;
  justify-content:space-between;
}
#help h3{
  font-size:1.17em;
  margin:1em 0;
  font-weight:bold;
}
#help .grid{
  display:grid;
  gap:12px;
}
#help .card{
  border:1px solid var(--edge);
  border-radius:14px;
  padding:12px;
  background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));
  display:flex;
  flex-direction:column;
  gap:8px;
}
#help .card h4{
  margin:.1rem 0 .2rem;
}
#help ul{
  margin:1em 0;
  padding-inline-start:40px;
  font-size:1rem;
  line-height:1.4;
}
#help li{ margin:0 0 .25em 0; }
#help #helpClose{
  width:36px;
  height:36px;
  padding:0;
  display:grid;
  place-items:center;
  border-radius:12px;
  font-size:1rem;
  font-weight:900;
  line-height:1;
}
body.light-theme #help{
  background:rgba(243,244,255,.95);
}
body.light-theme #help .box{
  background:#ffffff;
  color:#0b1120;
  box-shadow:0 30px 80px rgba(15,23,42,.15);
  border-color:rgba(148,163,184,.25);
}

#help, #help *{
  user-select:none;
  -webkit-user-select:none;
}
body:not(.light-theme).help-open header,
body:not(.light-theme).help-open main,
body:not(.light-theme).help-open footer,
body:not(.light-theme).help-open .top-menu{
  filter: blur(4px) brightness(.85);
  pointer-events: none;
  user-select: none;
  opacity: 0.95;
  transition: filter .18s ease, opacity .18s ease;
}
</style>

<script>
  (function(){
    "use strict";

    function byId(id){ return document.getElementById(id); }

    function clamp(v,min,max){ return v < min ? min : (v > max ? max : v); }

    function fmt(num){
      var a = Math.abs(num);
      if(a >= 1e4 || (a !== 0 && a < 1e-3)){
        return num.toExponential(2);
      }
      return (Math.round(num * 1000) / 1000).toString();
    }

    function lerp(a,b,t){ return a + (b - a) * t; }

    /* theme toggle */
    var themeToggle = byId("themeToggle");
    if(themeToggle){
      themeToggle.setAttribute("aria-pressed", document.body.classList.contains("light-theme") ? "true" : "false");
    }

    /* canvas & viewport */
    var canvas = byId("orbitCanvas");
    var ctx = canvas.getContext("2d");
    var dpr = window.devicePixelRatio || 1;

    var view = { centerX:0, centerY:0, scale:1.0 };

    function resizeCanvas(){
      var rect = canvas.getBoundingClientRect();
      var width = rect.width;
      var height = rect.height;
      canvas.width = width * dpr;
      canvas.height = height * dpr;
      ctx.setTransform(dpr,0,0,dpr,0,0);
      view.centerX = width/2;
      view.centerY = height/2;
      drawScene();
    }

    window.addEventListener("resize", resizeCanvas);

    var isPanning = false;
    var panStart = {x:0,y:0};
    var viewStart = {x:0,y:0};

    canvas.addEventListener("mousedown", function(e){
      isPanning = true;
      panStart.x = e.clientX;
      panStart.y = e.clientY;
      viewStart.x = view.centerX;
      viewStart.y = view.centerY;
    });

    window.addEventListener("mouseup", function(){
      isPanning = false;
    });

    window.addEventListener("mousemove", function(e){
      if(!isPanning) return;
      var dx = e.clientX - panStart.x;
      var dy = e.clientY - panStart.y;
      view.centerX = viewStart.x + dx;
      view.centerY = viewStart.y + dy;
      drawScene();
    });

    canvas.addEventListener("wheel", function(e){
      e.preventDefault();
      var rect = canvas.getBoundingClientRect();
      var mx = e.clientX - rect.left;
      var my = e.clientY - rect.top;

      var wheel = e.deltaY < 0 ? 1 : -1;
      var zoomFactor = Math.exp(wheel * 0.12);

      var worldXBefore = (mx - view.centerX) / view.scale;
      var worldYBefore = (my - view.centerY) / view.scale;

      view.scale *= zoomFactor;
      view.scale = clamp(view.scale,0.25,5.0);

      var worldXAfter = (mx - view.centerX) / view.scale;
      var worldYAfter = (my - view.centerY) / view.scale;

      var dx = worldXAfter - worldXBefore;
      var dy = worldYAfter - worldYBefore;

      view.centerX += dx * view.scale;
      view.centerY += dy * view.scale;

      drawScene();
    },{passive:false});

    function worldToScreenX(x){ return view.centerX + x * view.scale; }
    function worldToScreenY(y){ return view.centerY + y * view.scale; }

    /* SIMULATION STATUS */
    var GM = 15000;
    var x = 0, y = 0, vx = 0, vy = 0;
    var time = 0;
    var stepCount = 0;
    var dt = 0.016;
    var subSteps = 2;
    var integrator = "euler"; 

    var running = false;

    var trailEnabled = true;
    var trail = [];
    var maxTrail = 1500;

    var starBaseRadius = 18;
    var planetRadius = 5.5;
    var crashModeActive = false;
    var starCrashed = false;
    var starCrashAnimating = false;
    var starCrashT = 0;
    var starCrashDuration = 1.4;
    var starDestroyed = false;
    var lastRAF = 0;

    /* DOM REFERENCES */
    var inputGMRange        = byId("inputGMRange");
    var inputGM             = byId("inputGM");
    var inputRadiusRange    = byId("inputRadiusRange");
    var inputRadius         = byId("inputRadius");
    var inputSpeedFactorRange = byId("inputSpeedFactorRange");
    var inputSpeedFactor    = byId("inputSpeedFactor");
    var inputAngleRange     = byId("inputAngleRange");
    var inputAngle          = byId("inputAngle");
    var inputPhaseRange     = byId("inputPhaseRange");
    var inputPhase          = byId("inputPhase");
    var inputDtRange        = byId("inputDtRange");
    var inputDt             = byId("inputDt");
    var selectSubSteps      = byId("selectSubSteps");

    var btnPlayPause        = byId("btnPlayPause");
    var btnStep             = byId("btnStep");
    var btnClearTrail       = byId("btnClearTrail");

    var btnTrailToggle = byId("btnTrailToggle");
    var btnTrailLength = byId("btnTrailLength"); 
    var trailLengthRange = byId("trailLengthRange");
    var trailLengthBadge = byId("trailLengthBadge");

    var btnZoomIn = byId("btnZoomIn");
    var btnZoomOut = byId("btnZoomOut");
    var btnRecenter = byId("btnRecenter");

    var presetButtons = document.querySelectorAll(".preset-btn");

    var statusTime = byId("statusTime");
    var statusSteps = byId("statusSteps");
    var statusR = byId("statusR");
    var statusV = byId("statusV");
    var statusEk = byId("statusEk");
    var statusEp = byId("statusEp");
    var statusEtot = byId("statusEtot");
    var statusClass = byId("statusClass");

    var hudDot = byId("hudDot");
    var hudStateText = byId("hudStateText");
    var hudDt = byId("hudDt");
    var hudGM = byId("hudGM");

    var barR = byId("barR");
    var barV = byId("barV");
    var barEk = byId("barEk");
    var barEp = byId("barEp");
    var barEtot = byId("barEtot");
    var barClass = byId("barClass");

    function linkRangeAndNumber(rangeEl, numberEl, opts){
      var min = typeof opts.min === "number" ? opts.min : null;
      var max = typeof opts.max === "number" ? opts.max : null;
      var step = typeof opts.step === "number" ? opts.step : null;
      var onChange = typeof opts.onChange === "function" ? opts.onChange : function(){};

      function syncFromRange(){
        var v = parseFloat(rangeEl.value);
        if(isNaN(v)) return;
        if(numberEl){ numberEl.value = v; }
        onChange(v);
      }

      function syncFromNumber(){
        var v = parseFloat(numberEl.value);
        if(isNaN(v)) return;
        if(min !== null) v = Math.max(min,v);
        if(max !== null) v = Math.min(max,v);
        if(step !== null){
          var inv = 1/step;
          v = Math.round(v*inv)/inv;
        }
        numberEl.value = v;
        rangeEl.value = v;
        onChange(v);
      }

      rangeEl.addEventListener("input", syncFromRange);

      if(numberEl){
        numberEl.addEventListener("change", syncFromNumber);
        numberEl.addEventListener("blur", syncFromNumber);
        numberEl.addEventListener("keydown", function(e){
          if(e.key === "Enter"){ syncFromNumber(); }
        });
      }

      syncFromRange();
    }

    /* PRESETS */
    function applyPreset(name){
      presetButtons.forEach(function(btn){
        var tag = btn.getAttribute("data-preset");
        if(tag === name) btn.classList.add("preset-btn-active");
        else btn.classList.remove("preset-btn-active");
      });

      var r = parseFloat(inputRadius.value);
      var gm = parseFloat(inputGM.value);
      if(isNaN(r) || isNaN(gm) || r <= 0 || gm <= 0){
        r = 180;
        gm = 15000;
        inputRadius.value = r;
        inputGM.value = gm;
        inputRadiusRange.value = r;
        inputGMRange.value = gm;
      }

      var phaseDeg = 0;
      var angleDeg = 90;
      var factor = 1.0;

      if(name === "circular"){
        phaseDeg = 0; angleDeg = 90; factor = 1.0;
        crashModeActive = false;
      }else if(name === "elliptic"){
        phaseDeg = 0; angleDeg = 90; factor = 0.7;
        crashModeActive = false;
      }else if(name === "escape"){
        phaseDeg = 0; angleDeg = 90; factor = 1.4;
        crashModeActive = false;
      }else if(name === "crash"){
        phaseDeg = 45; angleDeg = 0; factor = 0.4;
        crashModeActive = true;
      }

      inputPhase.value = phaseDeg;
      inputPhaseRange.value = phaseDeg;
      inputAngle.value = angleDeg;
      inputAngleRange.value = angleDeg;
      inputSpeedFactor.value = factor;
      inputSpeedFactorRange.value = factor;

      initOrbitFromControls();
      resetTrail();
      drawScene();
    }

    presetButtons.forEach(function(btn){
      btn.addEventListener("click", function(){
        var p = btn.getAttribute("data-preset");
        applyPreset(p);
      });
    });

    /* ORBIT INITAL */
    function initOrbitFromControls(){
      GM = parseFloat(inputGM.value) || 15000;
      hudGM.textContent = GM.toString();

      var r = parseFloat(inputRadius.value) || 180;
      var factor = parseFloat(inputSpeedFactor.value) || 1.0;
      var angleDeg = parseFloat(inputAngle.value) || 90;
      var phaseDeg = parseFloat(inputPhase.value) || 0;

      var phaseRad = phaseDeg * Math.PI / 180;
      var angleRad = angleDeg * Math.PI / 180;

      x = r * Math.cos(phaseRad);
      y = r * Math.sin(phaseRad);

      var vcirc = Math.sqrt(GM / r);
      var vMag = vcirc * factor;

      vx = vMag * Math.cos(angleRad);
      vy = vMag * Math.sin(angleRad);

      time = 0;
      stepCount = 0;
      starCrashed = false;
      starCrashAnimating = false;
      starCrashT = 0;
      starDestroyed = false;

      resetTrail();
      addTrailPoint();
      updateStatus();
    }

    /* PHYSICS */
    function accel(x,y,GM){
      var r2 = x*x + y*y;
      var r = Math.sqrt(r2) || 1e-9;
      var invR3 = 1.0 / (r2 * r + 1e-12);
      var factor = -GM * invR3;
      return { ax:factor*x, ay:factor*y };
    }

    function stepEuler(dtLocal){
      var a = accel(x,y,GM);
      vx += a.ax * dtLocal;
      vy += a.ay * dtLocal;
      x  += vx  * dtLocal;
      y  += vy  * dtLocal;
    }

    function stepSimulationFrame(){
      var ss = subSteps | 0;
      if(ss < 1) ss = 1;
      var dtSub = dt / ss;

      for(var i=0;i<ss;i++){
        stepEuler(dtSub);
        time += dtSub;
        stepCount++;
        if(trailEnabled && stepCount % 2 === 0){
          addTrailPoint();
        }
      }
      // collision detection //
      var rNow = Math.sqrt(x*x + y*y);
      if(crashModeActive && !starCrashed && rNow <= (starBaseRadius + planetRadius)){
        starCrashAnimating = true;
        starCrashT = 0;
        starCrashed = true;
        running = false;
        if(btnPlayPause){
          btnPlayPause.textContent = "▶ Play";
          btnPlayPause.classList.remove("btn-primary");
          btnPlayPause.classList.add("btn-ghost");
        }
      }
      updateStatus();
    }

    /* TRAIL */
    function resetTrail(){ trail.length = 0; }
    function addTrailPoint(){
      if(!trailEnabled) return;
      trail.push({x:x,y:y});
      if(trail.length > maxTrail){
        trail.splice(0, trail.length - maxTrail);
      }
    }

    /* DRAWING */
    function drawScene(){
      var width = canvas.clientWidth;
      var height = canvas.clientHeight;
      ctx.clearRect(0,0,width,height);
      drawBackgroundGrid();
      drawStar();
      drawTrail();
      drawPlanet();
    }

    function drawBackgroundGrid(){
      var width = canvas.clientWidth;
      var height = canvas.clientHeight;

      ctx.save();
      ctx.lineWidth = 1;
      ctx.strokeStyle = "rgba(148,163,184,0.13)";
      ctx.beginPath();
      ctx.moveTo(0, view.centerY);
      ctx.lineTo(width, view.centerY);
      ctx.moveTo(view.centerX, 0);
      ctx.lineTo(view.centerX, height);
      ctx.stroke();

      var maxRadius = Math.min(width,height) * 0.45;
      var r1 = maxRadius * 0.33;
      var r2 = maxRadius * 0.66;

      ctx.strokeStyle = "rgba(148,163,184,0.09)";
      ctx.beginPath();
      ctx.arc(view.centerX, view.centerY, r1, 0, Math.PI*2);
      ctx.arc(view.centerX, view.centerY, r2, 0, Math.PI*2);
      ctx.stroke();
      ctx.restore();
    }

    function drawStar(){
      var sx = view.centerX;
      var sy = view.centerY;
      var starR = starBaseRadius;

      if(starCrashAnimating){
        var p = Math.min(1, starCrashT / starCrashDuration);
        var expand = 1 + Math.pow(p,0.6) * 4.5;
        starR = starBaseRadius * expand;
        var alpha = lerp(0.95, 0.05, p);
        var grad = ctx.createRadialGradient(sx, sy, 2, sx, sy, starR + 8);
        grad.addColorStop(0, "rgba(255,110,25," + (1 - p*0.1) + ")");
        grad.addColorStop(0.35, "rgba(255,180,60," + (0.9 - p*0.3) + ")");
        grad.addColorStop(0.7, "rgba(200,80,30," + (0.6 - p*0.4) + ")");
        grad.addColorStop(1.0, "rgba(120,30,20," + (0.06 * (1 - p)) + ")");

        ctx.save();
        ctx.beginPath();
        ctx.fillStyle = grad;
        ctx.arc(sx, sy, Math.max(1, starR + 8), 0, Math.PI*2);
        ctx.fill();
        ctx.restore();

        ctx.save();
        ctx.beginPath();
        ctx.fillStyle = "rgba(255,160,40," + (alpha) + ")";
        ctx.arc(sx, sy, Math.max(1, starR), 0, Math.PI*2);
        ctx.fill();
        ctx.restore();

        var rays = Math.floor(8 + p*22);
        ctx.save();
        ctx.globalAlpha = 0.7 * (1 - p);
        ctx.strokeStyle = "rgba(255,200,80," + (0.8 - p*0.6) + ")";
        ctx.lineWidth = 1.4;
        for(var i=0;i<rays;i++){
          var a = (i / rays) * Math.PI * 2 + (p * 6);
          var lx = sx + Math.cos(a) * (starR * 0.9 + p*20);
          var ly = sy + Math.sin(a) * (starR * 0.9 + p*20);
          ctx.beginPath();
          ctx.moveTo(sx + Math.cos(a) * (starR * 0.3), sy + Math.sin(a) * (starR * 0.3));
          ctx.lineTo(lx, ly);
          ctx.stroke();
        }
        ctx.restore();

        return;
      }

      if(starDestroyed){
        ctx.save();
        ctx.beginPath();
        ctx.fillStyle = "linear-gradient(180deg, rgba(30,30,30,1), rgba(10,10,10,1))";
        ctx.fillStyle = "#3b3b3b";
        ctx.arc(sx, sy, Math.max(6, starBaseRadius * 0.8), 0, Math.PI*2);
        ctx.fill();
        ctx.restore();
        return;
      }

      var grad = ctx.createRadialGradient(
        sx - 4, sy - 4, 2,
        sx, sy, starR + 8
      );
      grad.addColorStop(0,"rgba(253,224,71,1.0)");
      grad.addColorStop(0.4,"rgba(252,211,77,0.95)");
      grad.addColorStop(0.7,"rgba(250,204,21,0.5)");
      grad.addColorStop(1.0,"rgba(250,204,21,0.05)");

      ctx.save();
      ctx.beginPath();
      ctx.fillStyle = grad;
      ctx.arc(sx,sy,starR + 8,0,Math.PI*2);
      ctx.fill();
      ctx.restore();

      ctx.save();
      ctx.beginPath();
      ctx.fillStyle = "#facc15";
      ctx.arc(sx,sy,starR,0,Math.PI*2);
      ctx.fill();
      ctx.restore();
    }

    function drawTrail(){
      if(!trailEnabled || trail.length < 2) return;

      ctx.save();
      ctx.lineWidth = 1.4;
      ctx.lineJoin = "round";
      ctx.lineCap = "round";

      var n = trail.length;
      for(var i=1;i<n;i++){
        var p0 = trail[i-1];
        var p1 = trail[i];

        var sx0 = worldToScreenX(p0.x);
        var sy0 = worldToScreenY(p0.y);
        var sx1 = worldToScreenX(p1.x);
        var sy1 = worldToScreenY(p1.y);

        var t = i / n;
        var alpha = lerp(0.05,0.85,t);
        ctx.strokeStyle = "rgba(79,209,197," + alpha.toFixed(3) + ")";
        ctx.beginPath();
        ctx.moveTo(sx0,sy0);
        ctx.lineTo(sx1,sy1);
        ctx.stroke();
      }

      ctx.restore();
    }

    function drawPlanet(){
      var sx = worldToScreenX(x);
      var sy = worldToScreenY(y);

      ctx.save();

      ctx.beginPath();
      ctx.fillStyle = "rgba(59,130,246,0.25)";
      ctx.arc(sx,sy,10,0,Math.PI*2);
      ctx.fill();

      ctx.beginPath();
      ctx.fillStyle = "#60a5fa";
      ctx.arc(sx,sy,5.5,0,Math.PI*2);
      ctx.fill();

      var a = accel(x,y,GM);
      var len = 28;
      var mag = Math.sqrt(a.ax*a.ax + a.ay*a.ay) || 1e-9;
      var ux = a.ax / mag;
      var uy = a.ay / mag;

      ctx.beginPath();
      ctx.strokeStyle = "rgba(239,246,255,0.65)";
      ctx.lineWidth = 1.3;
      ctx.moveTo(sx,sy);
      ctx.lineTo(sx + ux*len, sy + uy*len);
      ctx.stroke();

      var arrowX = sx + ux*len;
      var arrowY = sy + uy*len;

      ctx.beginPath();
      ctx.moveTo(arrowX, arrowY);
      ctx.lineTo(
        arrowX - uy*5 - ux*4,
        arrowY + ux*5 - uy*4
      );
      ctx.lineTo(
        arrowX + uy*5 - ux*4,
        arrowY - ux*5 - uy*4
      );
      ctx.closePath();
      ctx.fillStyle = "rgba(239,246,255,0.85)";
      ctx.fill();

      ctx.restore();
    }

    /* STATUS */
    function updateStatus(){
      var r = Math.sqrt(x*x + y*y);
      var v = Math.sqrt(vx*vx + vy*vy);

      var Ek = 0.5 * v * v;
      var Ep = -GM / (r || 1e-9);
      var Etot = Ek + Ep;

      statusTime.textContent  = fmt(time);
      statusSteps.textContent = stepCount.toString();
      statusR.textContent     = fmt(r);
      statusV.textContent     = fmt(v);
      statusEk.textContent    = fmt(Ek);
      statusEp.textContent    = fmt(Ep);
      statusEtot.textContent  = fmt(Etot);

      var clazz = "–";
      if(Etot < 0) clazz = "Bound (elliptic)";
      else if(Math.abs(Etot) < 1e-3) clazz = "Parabolic";
      else if(Etot > 0) clazz = "Unbound (hyperbolic)";
      statusClass.textContent = clazz;

      hudDt.textContent = fmt(dt * subSteps);
      hudGM.textContent = GM.toString();

      if(running){
        hudDot.style.background = "#4ade80";
        hudDot.style.boxShadow = "0 0 0 3px rgba(34,197,94,.5)";
        hudStateText.textContent = "Running";
      }else{
        hudDot.style.background = "#f59e0b";
        hudDot.style.boxShadow = "0 0 0 3px rgba(245,158,11,.5)";
        hudStateText.textContent = "Paused";
      }

      function clamp01(v){ return Math.max(0, Math.min(1, v)); }

      var rNorm = clamp01(r / 420);          
      var vNorm = clamp01(v / 60);            
      var ekNorm = clamp01(Ek / 400);        
      var epNorm = clamp01(Math.abs(Ep) / 800); 
      var etotNorm = clamp01(Math.abs(Etot) / 800);

      if(barR) barR.style.width = (rNorm*100) + "%";
      if(barV) barV.style.width = (vNorm*100) + "%";
      if(barEk) barEk.style.width = (ekNorm*100) + "%";
      if(barEp) barEp.style.width = (epNorm*100) + "%";
      if(barEtot) barEtot.style.width = (etotNorm*100) + "%";

      // E Sign //
      if(barClass){
        if(Etot < 0){
          barClass.style.width = (clamp01(Math.abs(Etot)/800) * 100) + "%";
          barClass.style.background = "linear-gradient(90deg,#9ae6b4,#4fd1c5)";
        } else if(Etot > 0){
          barClass.style.width = (clamp01(Math.abs(Etot)/800) * 100) + "%";
          barClass.style.background = "linear-gradient(90deg,#fecaca,#f56565)";
        } else {
          barClass.style.width = "0%";
        }
      }

      drawScene();
    }

    /* buttons */
    btnPlayPause.addEventListener("click", function(){
      running = !running;
      btnPlayPause.textContent = running ? "⏸ Pause" : "▶ Play";
      btnPlayPause.classList.toggle("btn-primary", running);
      btnPlayPause.classList.toggle("btn-ghost", !running);
      updateStatus();
    });

    btnStep.addEventListener("click", function(){
      stepSimulationFrame();
      addTrailPoint();
      updateStatus();
    });

    btnClearTrail.addEventListener("click", function(){
      resetTrail();
      updateStatus();
    });

    btnTrailToggle.addEventListener("click", function(){
      trailEnabled = !trailEnabled;
      var txtEl = byId("btnTrailToggleText");
      if(txtEl) txtEl.textContent = trailEnabled ? "Trail: ON" : "Trail: OFF";
      if(!trailEnabled) resetTrail(); else addTrailPoint();
      updateStatus();
    });

    if(trailLengthRange){
      trailLengthRange.addEventListener("input", function(){
        maxTrail = parseInt(trailLengthRange.value,10) || maxTrail;
        if(trailLengthBadge) trailLengthBadge.textContent = maxTrail;
        if(trail.length > maxTrail){
          trail.splice(0, trail.length - maxTrail);
        }
        updateStatus();
      });
      if(trailLengthBadge) trailLengthBadge.textContent = maxTrail;
    }

    if(btnTrailLength){
      btnTrailLength.addEventListener("click", function(){
        var options = [600,1500,3000,6000];
        var idx = options.indexOf(maxTrail);
        if(idx === -1) idx = 0;
        idx = (idx + 1) % options.length;
        maxTrail = options[idx];
        if(trailLengthRange) trailLengthRange.value = maxTrail;
        if(trailLengthBadge) trailLengthBadge.textContent = maxTrail;
        if(trail.length > maxTrail){
          trail.splice(0, trail.length - maxTrail);
        }
        updateStatus();
      });
    }

    btnZoomIn.addEventListener("click", function(){
      view.scale *= 1.25;
      view.scale = clamp(view.scale,0.25,5.0);
      updateStatus();
    });

    btnZoomOut.addEventListener("click", function(){
      view.scale *= 0.8;
      view.scale = clamp(view.scale,0.25,5.0);
      updateStatus();
    });

    btnRecenter.addEventListener("click", function(){
      var width = canvas.clientWidth;
      var height = canvas.clientHeight;
      view.centerX = width/2;
      view.centerY = height/2;
      updateStatus();
    });

    /* range linking */
    linkRangeAndNumber(inputGMRange, inputGM, {
      min:5000,
      max:40000,
      step:500,
      onChange:function(v){
        GM = v;
        hudGM.textContent = GM.toString();
        initOrbitFromControls();
      }
    });

    linkRangeAndNumber(inputRadiusRange, inputRadius, {
      min:80,
      max:260,
      step:5,
      onChange:function(){ initOrbitFromControls(); }
    });

    linkRangeAndNumber(inputSpeedFactorRange, inputSpeedFactor, {
      min:0.2,
      max:2.2,
      step:0.05,
      onChange:function(){ initOrbitFromControls(); }
    });

    linkRangeAndNumber(inputAngleRange, inputAngle, {
      min:-180,
      max:180,
      step:5,
      onChange:function(){ initOrbitFromControls(); }
    });

    linkRangeAndNumber(inputPhaseRange, inputPhase, {
      min:0,
      max:360,
      step:5,
      onChange:function(){ initOrbitFromControls(); }
    });

    linkRangeAndNumber(inputDtRange, inputDt, {
      min:0.002,
      max:0.06,
      step:0.002,
      onChange:function(v){ dt = v; updateStatus(); }
    });

    selectSubSteps.addEventListener("change", function(){
      var v = parseInt(selectSubSteps.value,10) || 1;
      subSteps = v;
      updateStatus();
    });

    (function(){
      try {
        var toggles = document.querySelectorAll(".ctrl-toggle");
        function setToggleState(toggle, on){
          toggle.classList.toggle("ctrl-toggle--off", !on);
          var targetId = toggle.getAttribute("data-target");
          if(!targetId) return;
          var rangeEl = document.getElementById(targetId);
          var numEl = null;
          if(rangeEl){
            var base = targetId.replace(/Range$/,"");
            numEl = document.getElementById(base);
          }
          if(rangeEl) rangeEl.disabled = !on;
          if(numEl) numEl.disabled = !on;
          var parent = toggle.parentElement;
          if(parent) parent.classList.toggle("control-active", on);
        }

        toggles.forEach(function(t){
          var isOn = !t.classList.contains("ctrl-toggle--off");
          setToggleState(t, isOn);
          t.addEventListener("click", function(){
            isOn = !isOn;
            setToggleState(t, isOn);
          });
        });
      } catch(e){
      }
    })();

    function frame(now){
      if(!lastRAF) lastRAF = now || performance.now();
      var delta = Math.max(0, ((now || performance.now()) - lastRAF) / 1000);
      lastRAF = now || performance.now();

      if(running){
        stepSimulationFrame();
      }

      if(starCrashAnimating){
        starCrashT += delta;
        if(starCrashT >= starCrashDuration){
          starCrashAnimating = false;
          starDestroyed = true;
        }
        updateStatus();
      }

      requestAnimationFrame(frame);
    }

    /* INITIAL */
    resizeCanvas();
    initOrbitFromControls();
    applyPreset("circular");
    updateStatus();
    requestAnimationFrame(frame);

    // Reset View //
    var btnResetEl = byId("btnReset");
    if(btnResetEl){
      btnResetEl.addEventListener("click", function(){
        var width = canvas.clientWidth;
        var height = canvas.clientHeight;
        view.scale = 1.0;
        view.centerX = width/2;
        view.centerY = height/2;
        drawScene();
      });
    }

    // Export Video //
    var exportBtn = byId("btnExport");
    var mediaRecorder = null;
    var recordedChunks = [];
    var isRecording = false;

    function startRecording(){
      try {
        var fps = 30;
        var stream = canvas.captureStream(fps);
        recordedChunks = [];
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/mp4' });
        mediaRecorder.ondataavailable = function(e){
          if(e.data && e.data.size) recordedChunks.push(e.data);
        };
        mediaRecorder.onstop = function(){
          var blob = new Blob(recordedChunks, { type: 'video/mp4' });
          var url = URL.createObjectURL(blob);
          var a = document.createElement('a');
          a.href = url;
          a.download = 'chronos-sim.mp4';
          document.body.appendChild(a);
          a.click();
          a.remove();
          setTimeout(function(){ URL.revokeObjectURL(url); }, 2000);
          recordedChunks = [];
        };
        mediaRecorder.start();
        isRecording = true;
        exportBtn.textContent = "Stop Export";
        exportBtn.classList.add("btn-danger");
      } catch(err){
        console.error("Recording not available", err);
        alert("Video recording is not supported in this browser.");
      }
    }

    function stopRecording(){
      if(mediaRecorder && mediaRecorder.state !== "inactive"){
        mediaRecorder.stop();
      }
      isRecording = false;
      exportBtn.textContent = "Export Video";
      exportBtn.classList.remove("btn-danger");
    }

    if(exportBtn){
      exportBtn.addEventListener("click", function(){
        if(!isRecording){
          startRecording();
        } else {
          stopRecording();
        }
      });
    }

    // THEME TOGGLE //
    (function(){
      var themeToggleBtn = byId("themeToggle");
      var themeMenuBtn = document.querySelector('#topMenu .menu-item[data-action="theme"]');
      if(!themeToggleBtn) return;

      function sunIcon(){ return '☀︎'; }
      function moonIcon(){ return '☾'; }

      function updateThemeButtons(isLight){
        var icon = isLight ? sunIcon() : moonIcon();
        themeToggleBtn.textContent = icon;
        themeToggleBtn.setAttribute("aria-pressed", isLight ? "true" : "false");
        if(themeMenuBtn){
          themeMenuBtn.textContent = icon;
          themeMenuBtn.setAttribute("aria-pressed", isLight ? "true" : "false");
        }
      }

      var initialIsLight = document.body.classList.contains('light-theme');
      updateThemeButtons(initialIsLight);

      themeToggleBtn.addEventListener("click", function(){
        var body = document.body;
        var isLight = body.classList.toggle("light-theme");
        updateThemeButtons(isLight);
      });
    })();

    (function(){
      var headerInner = document.querySelector('.header-inner');
      var navBrand = document.querySelector('.nav-brand');
      var navActions = byId('navActions');
      var menuToggle = byId('menuToggle');
      var topMenu = byId('topMenu');
      var btnResetEl = byId("btnReset");
      var exportBtn = byId("btnExport");
      var themeBtn = byId("themeToggle");
      var helpBtn = byId("btnHelp");

      var lastAppliedCollapse = null;

      function measureActionsWidth(){
        if(!navActions) return 0;
        var wasCollapsed = navActions.classList.contains('nav-collapsed');
        var prevVisibility = navActions.style.visibility;
        var prevToggleDisplay = menuToggle ? menuToggle.style.display : '';

        navActions.classList.remove('nav-collapsed');
        if(menuToggle) menuToggle.style.display = 'none';
        navActions.style.visibility = 'hidden';

        var w = navActions.scrollWidth;

        navActions.style.visibility = prevVisibility || '';
        if(wasCollapsed) navActions.classList.add('nav-collapsed');
        if(menuToggle) menuToggle.style.display = prevToggleDisplay || '';
        return w;
      }

      function computeShouldCollapse(){
        if(!headerInner || !navBrand || !navActions) return false;
        var wasCollapsed = navActions.classList.contains('nav-collapsed');
        var prevVisibility = navActions.style.visibility;
        var prevToggleDisplay = menuToggle ? menuToggle.style.display : '';

        navActions.classList.remove('nav-collapsed');
        if(menuToggle) menuToggle.style.display = 'none';
        navActions.style.visibility = 'hidden';

        var brandRect = navBrand.getBoundingClientRect();
        var actionsRect = navActions.getBoundingClientRect();
        var brandW = brandRect.width;
        var actionsW = actionsRect.width || measureActionsWidth();
        var available = headerInner.clientWidth;
        var paddingAllowance = 80; 

        navActions.style.visibility = prevVisibility || '';
        if(wasCollapsed) navActions.classList.add('nav-collapsed');
        if(menuToggle) menuToggle.style.display = prevToggleDisplay || '';
        if(window.innerWidth < 1260) return true;
        return (brandW + actionsW + paddingAllowance) > available;
      }

      function applyCollapseState(shouldCollapse){
        if(!navActions || !menuToggle || !topMenu) return;
        if(shouldCollapse){
          navActions.classList.add('nav-collapsed');
          menuToggle.style.display = 'inline-flex';
        } else {
          navActions.classList.remove('nav-collapsed');
          menuToggle.style.display = 'none';
          topMenu.style.display = 'none';
          topMenu.setAttribute('aria-hidden','true');
        }
      }

      var resizeTimer = null;
      function scheduleUpdate(){
        if(resizeTimer) clearTimeout(resizeTimer);
        resizeTimer = setTimeout(function(){
          var shouldCollapse = computeShouldCollapse();
          if(shouldCollapse === lastAppliedCollapse) return;
          applyCollapseState(shouldCollapse);
          lastAppliedCollapse = shouldCollapse;
        }, 80);
      }

      if(menuToggle && topMenu){
        menuToggle.addEventListener('click', function(e){
          e.stopPropagation();
          var isOpen = topMenu.style.display === 'flex';
          topMenu.style.display = isOpen ? 'none' : 'flex';
          topMenu.setAttribute('aria-hidden', isOpen ? 'true' : 'false');
        });

        topMenu.addEventListener('click', function(e){
          var btn = e.target.closest('.menu-item');
          if(!btn) return;
          var action = btn.getAttribute('data-action');
          if(action === 'reset'){ btnResetEl && btnResetEl.click(); }
          else if(action === 'export'){ exportBtn && exportBtn.click(); }
          else if(action === 'theme'){ themeBtn && themeBtn.click(); }
          else if(action === 'help'){ helpBtn && helpBtn.click(); }
          topMenu.style.display = 'none';
          topMenu.setAttribute('aria-hidden','true');
        });

        window.addEventListener('click', function(e){
          if(topMenu && topMenu.style.display === 'flex'){
            if(!topMenu.contains(e.target) && !menuToggle.contains(e.target)){
              topMenu.style.display = 'none';
              topMenu.setAttribute('aria-hidden','true');
            }
          }
        });

        window.addEventListener('resize', scheduleUpdate);
        window.addEventListener('load', scheduleUpdate);

        try {
          var ro = new ResizeObserver(function(){ scheduleUpdate(); });
          if(headerInner) ro.observe(headerInner);
          if(navActions) ro.observe(navActions);
        } catch(e){
          var fallbackTimer = setInterval(function(){ scheduleUpdate(); }, 600);
          setTimeout(function(){ clearInterval(fallbackTimer); }, 8000);
        }

        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", scheduleUpdate);
        } else {
          scheduleUpdate();
        }
      }

    })();

    // Help Tab // 
    var helpBtn = byId("btnHelp");
    var helpEl = byId("help");
    var helpClose = byId("helpClose");

    function showHelp(){
      if(!helpEl) return;
      helpEl.style.display = "flex";
      document.body.classList.add("help-open");
    }
    function hideHelp(){
      if(!helpEl) return;
      helpEl.style.display = "none";
      document.body.classList.remove("help-open");
    }

    if(helpBtn && helpEl){
      helpBtn.addEventListener("click", function(){ showHelp(); });
    }
    if(helpClose && helpEl){
      helpClose.addEventListener("click", function(e){ e.stopPropagation(); hideHelp(); });
    }
    if(helpEl){
      helpEl.addEventListener("click", function(e){
        if(e.target === helpEl){ hideHelp(); }
      });
    }

    // Shortcuts //
    window.addEventListener("keydown", function(e){
      if(e.key === " "){ 
        e.preventDefault();
        btnPlayPause.click();
        return;
      }
      if(e.key === "r" || e.key === "R"){
        btnResetEl && btnResetEl.click();
        return;
      }
      if(e.key === "+" || e.key === "="){ btnZoomIn && btnZoomIn.click(); return; }
      if(e.key === "-" || e.key === "_"){ btnZoomOut && btnZoomOut.click(); return; }
      if(e.key === "e" || e.key === "E"){ exportBtn && exportBtn.click(); return; }
      if(e.key === "Escape" && helpEl && helpEl.style.display === "flex"){ hideHelp(); return; }
      if(e.key === "?" || (e.shiftKey && e.key === "/")){ showHelp(); return; }
    });

  })();
</script>

<footer class="site-footer"> © 2025 DELONEX & Koo Kim (DELTA STEINER) | All rights reserved.
</footer>

</body>
</html>